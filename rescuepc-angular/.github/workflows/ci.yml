name: ğŸš€ CI/CD Pipeline - RescuePC Angular

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]
  workflow_dispatch:

env:
  NODE_VERSION: '18.17.0'
  PNPM_VERSION: '8.15.0'

jobs:
  # =============================================================================
  # ğŸ” CODE QUALITY & LINTING
  # =============================================================================
  lint:
    name: ğŸ” Lint & Format Check
    runs-on: ubuntu-latest
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸŸ¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'pnpm'

      - name: ğŸ“¦ Install pnpm
        uses: pnpm/action-setup@v2
        with:
          version: ${{ env.PNPM_VERSION }}

      - name: ğŸ“¦ Install dependencies
        run: pnpm install --frozen-lockfile

      - name: ğŸ” Lint all projects
        run: nx run-many --target=lint --all

      - name: ğŸ¨ Check formatting
        run: nx format:check

  # =============================================================================
  # ğŸ§ª UNIT TESTS
  # =============================================================================
  test:
    name: ğŸ§ª Unit Tests
    runs-on: ubuntu-latest
    strategy:
      matrix:
        project: [frontend, api, shared, stripe, license, ui]
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸŸ¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'pnpm'

      - name: ğŸ“¦ Install pnpm
        uses: pnpm/action-setup@v2
        with:
          version: ${{ env.PNPM_VERSION }}

      - name: ğŸ“¦ Install dependencies
        run: pnpm install --frozen-lockfile

      - name: ğŸ§ª Run tests
        run: nx test ${{ matrix.project }} --coverage --watch=false

      - name: ğŸ“Š Upload coverage
        uses: codecov/codecov-action@v3
        with:
          file: ./coverage/lcov.info
          flags: ${{ matrix.project }}
          name: ${{ matrix.project }}-coverage

  # =============================================================================
  # ğŸ—ï¸ BUILD & COMPILE
  # =============================================================================
  build:
    name: ğŸ—ï¸ Build Applications
    runs-on: ubuntu-latest
    needs: [lint, test]
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸŸ¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'pnpm'

      - name: ğŸ“¦ Install pnpm
        uses: pnpm/action-setup@v2
        with:
          version: ${{ env.PNPM_VERSION }}

      - name: ğŸ“¦ Install dependencies
        run: pnpm install --frozen-lockfile

      - name: ğŸ—ï¸ Build frontend
        run: nx build frontend --prod

      - name: ğŸ—ï¸ Build API
        run: nx build api --prod

      - name: ğŸ—ï¸ Build libraries
        run: nx run-many --target=build --all

      - name: ğŸ“¦ Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: build-artifacts
          path: |
            dist/
            .nx/cache/

  # =============================================================================
  # ğŸ§ª E2E TESTS
  # =============================================================================
  e2e:
    name: ğŸ§ª End-to-End Tests
    runs-on: ubuntu-latest
    needs: [build]
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸŸ¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'pnpm'

      - name: ğŸ“¦ Install pnpm
        uses: pnpm/action-setup@v2
        with:
          version: ${{ env.PNPM_VERSION }}

      - name: ğŸ“¦ Install dependencies
        run: pnpm install --frozen-lockfile

      - name: ğŸ“¥ Download build artifacts
        uses: actions/download-artifact@v4
        with:
          name: build-artifacts
          path: .

      - name: ğŸ§ª Run E2E tests
        run: nx e2e frontend-e2e --watch=false

      - name: ğŸ“¸ Upload screenshots
        uses: actions/upload-artifact@v4
        if: failure()
        with:
          name: e2e-screenshots
          path: apps/frontend-e2e/screenshots/

  # =============================================================================
  # ğŸ”’ SECURITY SCAN
  # =============================================================================
  security:
    name: ğŸ”’ Security Audit
    runs-on: ubuntu-latest
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸŸ¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'pnpm'

      - name: ğŸ“¦ Install pnpm
        uses: pnpm/action-setup@v2
        with:
          version: ${{ env.PNPM_VERSION }}

      - name: ğŸ“¦ Install dependencies
        run: pnpm install --frozen-lockfile

      - name: ğŸ” Run security audit
        run: pnpm audit --audit-level=moderate

      - name: ğŸ” Run ESLint security rules
        run: nx run-many --target=lint --all --fix

  # =============================================================================
  # ğŸ“Š PERFORMANCE TESTING
  # =============================================================================
  performance:
    name: ğŸ“Š Performance Testing
    runs-on: ubuntu-latest
    needs: [build]
    if: github.ref == 'refs/heads/main'
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸŸ¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'pnpm'

      - name: ğŸ“¦ Install pnpm
        uses: pnpm/action-setup@v2
        with:
          version: ${{ env.PNPM_VERSION }}

      - name: ğŸ“¦ Install dependencies
        run: pnpm install --frozen-lockfile

      - name: ğŸ“¥ Download build artifacts
        uses: actions/download-artifact@v4
        with:
          name: build-artifacts
          path: .

      - name: ğŸš€ Start server
        run: |
          nx serve api &
          sleep 10

      - name: ğŸ“Š Run Lighthouse CI
        uses: treosh/lighthouse-ci-action@v10
        with:
          urls: |
            http://localhost:4000
          uploadArtifacts: true
          temporaryPublicStorage: true

  # =============================================================================
  # ğŸš€ DEPLOYMENT
  # =============================================================================
  deploy:
    name: ğŸš€ Deploy to Production
    runs-on: ubuntu-latest
    needs: [lint, test, build, e2e, security]
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    environment: production
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸŸ¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'pnpm'

      - name: ğŸ“¦ Install pnpm
        uses: pnpm/action-setup@v2
        with:
          version: ${{ env.PNPM_VERSION }}

      - name: ğŸ“¦ Install dependencies
        run: pnpm install --frozen-lockfile

      - name: ğŸ—ï¸ Build for production
        run: |
          nx build frontend --prod
          nx build api --prod

      - name: ğŸš€ Deploy to Vercel
        uses: amondnet/vercel-action@v25
        with:
          vercel-token: ${{ secrets.VERCEL_TOKEN }}
          vercel-org-id: ${{ secrets.VERCEL_ORG_ID }}
          vercel-project-id: ${{ secrets.VERCEL_PROJECT_ID }}
          vercel-args: '--prod'

      - name: ğŸš€ Deploy API to Railway
        uses: bervProject/railway-deploy@v1.0.0
        with:
          railway_token: ${{ secrets.RAILWAY_TOKEN }}
          service: rescuepc-api

  # =============================================================================
  # ğŸ“ˆ MONITORING & ALERTS
  # =============================================================================
  monitor:
    name: ğŸ“ˆ Health Check
    runs-on: ubuntu-latest
    needs: [deploy]
    if: github.ref == 'refs/heads/main'
    steps:
      - name: ğŸ” Check API health
        run: |
          curl -f https://rescuepc-api.railway.app/api/health || exit 1

      - name: ğŸ” Check frontend
        run: |
          curl -f https://rescue-pc-repairs-multi-os-toolkit-ofrjwva13.vercel.app || exit 1

      - name: ğŸ“§ Send success notification
        if: success()
        run: |
          echo "âœ… Deployment successful!"
          # TODO: Add Slack/Discord notification

      - name: ğŸš¨ Send failure notification
        if: failure()
        run: |
          echo "âŒ Deployment failed!"
          # TODO: Add Slack/Discord notification

# =============================================================================
# ğŸ“‹ WORKFLOW SUMMARY
# =============================================================================
# This workflow ensures:
# âœ… Code quality through linting and formatting
# âœ… Reliability through comprehensive testing
# âœ… Security through audits and scans
# âœ… Performance through Lighthouse testing
# âœ… Automated deployment to production
# âœ… Health monitoring and alerting
# =============================================================================
